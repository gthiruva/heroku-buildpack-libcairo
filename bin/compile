#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# debug
# set -x
echo "-----> We are in '$PWD' with contents:"
ls -a
echo "-----> Present PATH's:"
export PATH="/usr/local/bin:/usr/bin:/bin:$PATH"
export LD_RUN_PATH="/usr/local/lib:/usr/lib:/lib:$LD_RUN_PATH"
export LD_LIBRARY_PATH="$LD_RUN_PATH"
export PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:/usr/lib/pkgconfig:/lib/pkgconfig:$PKG_CONFIG_PATH"
echo "PATH: '$PATH'"
echo "LD_RUN_PATH: '$LD_RUN_PATH'"
echo "LD_LIBRARY_PATH: '$LD_LIBRARY_PATH'"
echo "PKG_CONFIG_PATH: '$PKG_CONFIG_PATH'"

# clean up leaking environment
unset GIT_DIR

# config
export PKG_CONFIG_PATH="/usr/lib64/pkgconfig:/opt/local/lib/pkgconfig:/usr/local/lib/pkgconfig:/usr/lib/pkgconfig:$PKG_CONFIG_PATH"

### libpixman is required for libcairo
if [[ "Darwin" == "$(uname)" ]]
then
    VENDORED_LIBPIXMAN="$HOME/Code/heroku-buildpack-libpixman/vendor/libpixman" # Just for my local laptop testing
else
    VENDORED_LIBPIXMAN="/app/vendor/libpixman"
fi

git clone git://anongit.freedesktop.org/git/pixman
cd pixman
autoreconf -v --install
./configure --prefix=$VENDORED_LIBPIXMAN
make
make install
export LD_RUN_PATH="$VENDORED_LIBPIXMAN/lib:/usr/local/lib:/usr/lib:/lib:$LD_RUN_PATH"
export LD_LIBRARY_PATH="$LD_RUN_PATH"
export PKG_CONFIG_PATH="$VENDORED_LIBPIXMAN/lib/pkgconfig:/usr/local/lib/pkgconfig:/usr/lib/pkgconfig:/lib/pkgconfig:$PKG_CONFIG_PATH"
cd ..
### End libpixman stuff

if [[ "Darwin" == "$(uname)" ]]
then
    VENDORED_LIBCAIRO="$HOME/Code/heroku-buildpack-libcairo/vendor/libcairo" # Just for my local laptop testing
else
    VENDORED_LIBCAIRO="/app/vendor/libcairo"
fi

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2

function tar_download() {
  url="$1"
  location="$2"

  mkdir -p $location
  curl $url -s -o - | tar xJf - -C $location
}

#Building libcairo
echo "-----> Building libcairo ... BUILD_DIR: $BUILD_DIR // CACHE_DIR: $CACHE_DIR // PWD: $PWD"
#tar_download "http://cairographics.org/releases/cairo-1.12.16.tar.xz" $BUILD_DIR/libcairo
git clone git://anongit.freedesktop.org/git/cairo $BUILD_DIR/libcairo/cairo-1.12.16
cd $BUILD_DIR/libcairo/cairo-1.12.16
#./autogen.sh --prefix=$VENDORED_LIBCAIRO
CFLAGS='-fPIC -Wall -g -O2' CXXFLAGS='-fPIC -Wall -g -O2' png_CFLAGS='-fPIC -Wall -g -O2' ./autogen.sh --with-pic --enable-static --disable-shared --prefix=$VENDORED_LIBCAIRO
make
make install
export PATH="$VENDORED_LIBCAIRO/bin:$PATH"
export LD_RUN_PATH="$VENDORED_LIBCAIRO/lib:$LD_RUN_PATH"
export LD_LIBRARY_PATH="$LD_RUN_PATH"
export PKG_CONFIG_PATH="$VENDORED_LIBCAIRO/lib/pkgconfig:$PKG_CONFIG_PATH"
cd ../..

echo "-----> Building runtime environment"
mkdir -p .profile.d
echo "export PATH=\"\$HOME/vendor/libcairo/bin:\$PATH\"" > .profile.d/libcairo.sh
echo "export LD_RUN_PATH=\"\$HOME/vendor/libcairo/lib:\$LD_RUN_PATH\"" > .profile.d/libcairo.sh
echo "export LD_LIBRARY_PATH=\"\$HOME/vendor/libcairo/lib:\$LD_LIBRARY_PATH\"" > .profile.d/libcairo.sh
echo "export PKG_CONFIG_PATH=\"\$HOME/vendor/libcairo/lib/pkgconfig:\$PKG_CONFIG_PATH\"" >> .profile.d/libcairo.sh
